[skew_correction]

[firmware_retraction]
retract_length: 0.7
retract_speed: 35
unretract_extra_length: 0
unretract_speed: 35

# Сохранение переменных
[save_variables]
filename: /opt/config/mod_data/variables.cfg

# Регулировка винтов
[screws_tilt_adjust]
screw1: -94, -94
screw1_name: front left screw
screw2: 94, -94
screw2_name: front right screw
screw3: 94, 94
screw3_name: rear right screw
screw4: -94, 94
screw4_name: rear left screw
horizontal_move_z: 10.
speed: 600.
screw_thread: CW-M4

# Макрос для M300 - Звук
[gcode_shell_command audio_freq]
command: audio freq
timeout: 3
verbose: False

[gcode_macro M300]
description: Воспроизвести тон
gcode:
    # Use a default 1kHz tone if S is omitted.
    {% set S = params.S|default(1000)|int %}
    # Use a 10ms duration is P is omitted.
    {% set P = params.P|default(100)|float %}
    RUN_SHELL_COMMAND CMD=audio_freq PARAMS="-f {S} -d {P / 1000}"

# Лунная соната
[gcode_macro M356]
description: Лунная соната
gcode:
    M300 S1318 P50
    M300 S1244 P50
    M300 S1318 P50
    M300 S1244 P50
    M300 S1318 P50
    M300 S987 P50
    M300 S1174 P50
    M300 S1046 P50
    M300 S880 P100

[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _BED_MESH_CALIBRATE
gcode:
    {% set zuse_kamp = printer.save_variables.variables.use_kamp|default(0) | int %}
    {% if zuse_kamp == 1 %}
        RESPOND PREFIX="info" MSG="Использую KAMP"
        _KAMP_BED_MESH_CALIBRATE
    {% else %}
        RESPOND PREFIX="info" MSG="Использую BED_MESH_CALIBRATE"
        _BED_MESH_CALIBRATE {rawparams}
    {% endif %}

[gcode_macro CHECK_MD5]
description: Проверка MD5 суммы файла
gcode:
  {% if 'FILENAME' in params %}
    {% set filename = params.FILENAME|default("")|string %}
  {% else %}
    {% set filename = printer.virtual_sdcard.file_path|default("")|string  %}
  {% endif %}

  SAVE_VARIABLE VARIABLE=check_md5 VALUE={0|int}

  {% if filename != "" %}
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28 Z
        M400
        G28 X
        G28 Y
        M400
        M400
    {% endif %}

    G1 Z110

    {% if 'DELETE' in params %}
      {% set delete = params.DELETE|default("False")|string %}
    {% endif %}

    RUN_SHELL_COMMAND CMD=check_md5 PARAMS={'"%s %s"' % (filename.replace(" ", "\ "), delete)}
    {% for i in range(30) %}
        ZLOAD_VARIABLE
        _CHECK_MD5
    {% endfor %}

    ZLOAD_VARIABLE
    _FINAL_CHECK_MD5 FILENAME="'{filename}'"

  {% endif %}

[gcode_macro _CHECK_MD5]
description: Ожидаем, когда проверка закончится
gcode:
    {% set check_md5 = printer.save_variables.variables.check_md5|default(0) | int %}

    {% if (check_md5 == 0) %}
        G4 P{1000}
    {% endif %}

[gcode_macro _FINAL_CHECK_MD5]
description: Финальный тест
gcode:
    {% set filename = params.FILENAME|default("")|string %}

    {% set check_md5 = printer.save_variables.variables.check_md5|default(0) | int %}
    RESPOND PREFIX="info" MSG="check_md5_final={check_md5}"

    {% if (check_md5 == 1) %}
        RESPOND PREFIX="error" MSG="Ошибка: Файл '{filename}' не указан. Печать отменена."
        CANCEL_PRINT
#        {action_raise_error("Ошибка: Файл '{filename}' не указан. Печать отменена.")}
    {% endif %}
    {% if (check_md5 == 2) %}
        RESPOND PREFIX="error" MSG="Ошибка: Файл {filename} не найден. Печать отменена."
        CANCEL_PRINT
#        {action_raise_error("Ошибка: Файл {filename} не найден. Печать отменена.")}
    {% endif %}
    {% if (check_md5 == 3) %}
        RESPOND PREFIX="info" MSG="В файле {filename} нет MD5 суммы. Включите ее в Orca."
    {% endif %}
    {% if (check_md5 == 4) %}
        RESPOND PREFIX="info" MSG="В файле {filename} найдено использование дуг(G2, G3). Отключите их. В Orca: Профиль процесса -> Аппроксимация дугами. Убрать галочку."
    {% endif %}
    {% if (check_md5 == 5) %}
        RESPOND PREFIX="info" MSG="Файл {filename} проверен успешно."
    {% endif %}
    {% if (check_md5 == 6) %}
        RESPOND PREFIX="error" MSG="В файле {filename} не совпала MD5 сумма. Файл удален. Печать отменена"
        CANCEL_PRINT
#        {action_raise_error("В файле {filename} не совпала MD5 сумма. Файл удален. Печать отменена")}
    {% endif %}
    {% if (check_md5 == 7) %}
        RESPOND PREFIX="error" MSG="В файле {filename} не совпала MD5 сумма. Печать отменена")}
        CANCEL_PRINT
#        {action_raise_error("В файле {filename} не совпала MD5 сумма. Печать отменена")}
    {% endif %}

# Проверка чек суммы md5
[gcode_shell_command check_md5]
command: /root/printer_data/scripts/checkMD5.sh
timeout: 65
verbose: False

[gcode_macro BED_LEVEL_SCREWS_TUNE]
description: Калибровка винтов стола
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(130)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}

    RESPOND PREFIX="info" MSG="До измерений, не забудьте почистить сопло макросом CLEAR_NOZZLE"

    BED_MESH_CLEAR
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder_temp}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
    TEMPERATURE_WAIT SENSOR=heater_bed  MINIMUM={bed_temp-2} MAXIMUM={bed_temp+3}
    TEMPERATURE_WAIT SENSOR=extruder  MINIMUM={extruder_temp-2} MAXIMUM={extruder_temp+3}

    G28 Z
    M400
    G28 X
    G28 Y
    M400
    M400

    SCREWS_TILT_CALCULATE

[gcode_macro LOAD_CELL_TARE]
description: Сброс веса тензодатчиков
variable_success: 0
gcode:
    RESPOND PREFIX="info" MSG="Сброс веса тензодатчиков"
    QUERY_BUTTON button=check_level_pin
    QUERY_PROBE button=QUERY_PROBE

    {% set we = printer['temperature_sensor weightValue'].temperature %}
    RESPOND PREFIX="info" MSG="Вес: {we}"

    # reset success
    SET_GCODE_VARIABLE MACRO=LOAD_CELL_TARE VARIABLE=success VALUE=0
    # try set tare, up to 10 times
    {% for i in range(10) %}
        _LOAD_CELL_TARE_IF_NO_SUCCESS ITER={i}
    {% endfor %}
    # final check if successfull
    _LOAD_CELL_TARE_FINAL_CHECK

[gcode_macro _LOAD_CELL_TARE_IF_NO_SUCCESS]
gcode:
    {% set iter = params.ITER|default(0)|int %}

    {% if not printer["gcode_macro LOAD_CELL_TARE"].success %}
        _LOAD_CELL_TARE_SET ITER={iter}
        _LOAD_CELL_TARE_CHECK
    {% endif %}

[gcode_macro _LOAD_CELL_TARE_SET]
gcode:
    {% set iter = params.ITER|default(0)|int %}

    RESPOND PREFIX="info" MSG="Поверка №{iter}"

    # Tare is set by toggeling _level_h1 pin
    SET_PIN PIN=level_h1 VALUE=0
    G4 P{505}
    M400
    SET_PIN PIN=level_h1 VALUE=1
    G4 P{505}
    M400
    SET_PIN PIN=level_h1 VALUE=0
    G4 P{505}
    M400
    SET_PIN PIN=level_h1 VALUE=1
    G4 P{505}
    M400

[gcode_macro _LOAD_CELL_TARE_CHECK]
gcode:
    QUERY_BUTTON button=check_level_pin
    QUERY_PROBE button=QUERY_PROBE

    {% set we = printer['temperature_sensor weightValue'].temperature %}
    RESPOND PREFIX="info" MSG="Вес: {we}"

    {% set check_level_pin = printer['gcode_button check_level_pin'].state %}
    #RESPOND PREFIX="info" MSG="check_level_pin={check_level_pin}"

    # If level check pin is set, tare is successfull.
    {% if "PRESSED" in printer['gcode_button check_level_pin'].state %}
        SET_GCODE_VARIABLE MACRO=LOAD_CELL_TARE VARIABLE=success VALUE=1
    {% endif %}

[gcode_macro _LOAD_CELL_TARE_FINAL_CHECK]
gcode:
    {% set we = printer['temperature_sensor weightValue'].temperature %}
    RESPOND PREFIX="info" MSG="Вес: {we}"

    # Check success
    {% if printer["gcode_macro LOAD_CELL_TARE"].success %}
        # Toggle level clear plin.
        # No sure what the level clear pin does. But we do the same as the stock software.
        SET_PIN PIN=level_clear VALUE=0
        G4 P6
        M400
        SET_PIN PIN=level_clear VALUE=1
        G4 P6
        M400
        RESPOND PREFIX="info" MSG="Сброс веса тензадатчиков прошел успешно."
    # Else raise error
    {% else %}
        {action_raise_error("Ошибка сброса веса тензадатчиков. Читайте FAQ: https://github.com/ghzserg/zmod/wiki/FAQ")}
    {% endif %}

[gcode_macro _CLEAR_NOZZLE]
gcode:
    M106 P0 S255
    {% set zprobe = printer.probe.last_z_result %}
    RESPOND PREFIX="info" MSG="Z-probe={zprobe}"

    G92 E0                   ; обнуляем количество выдавленного пластика

    G1 X-10 F3000
    G1 X-10 Y111 Z{zprobe+0.15} F3000 ; z+0.15
    RESPOND PREFIX="info" MSG="Начало очистки Z={zprobe+0.15}"
    G1 X20 F1200
    G1 X20 Y110 F1200
    G1 X0 Y110 F1200
    G1 X0 Y109 F1200
    G1 X20 Y109 F1200
    G1 X-10 Y108 F1200
    G1 Z{zprobe+0.05} F3000  ; z+0.05
    RESPOND PREFIX="info" MSG="Конец очистки Z={zprobe+0.05}"

[gcode_macro _PRE_CLEAR_NOZZLE]
description: Предочистка сопла
gcode:
    RESPOND PREFIX="info" MSG="Предочистка сопла"

    # wipe to left
    G90                     ; absolute coordinates
    G1 X80 Y110 Z5 F18000   ; get into position
    PROBE                   ; moove nozzle to bed
    G91                     ; relative position
    G1 X-40 F900            ; wipe move left

    # up
    G90
    G1 Z3 F3000

    # wipe to right
    G90                     ; absolute coordinates
    G1 X-80 Y110 Z5 F18000  ; get into position
    PROBE                   ; moove nozzle to bed
    G91                     ; relative position
    G1 X40 F900             ; wipe move right

    G90
    G1 X-20 Y111 F6000       ; Зависаем по центру
    G1 Z5 F3000
    M400

    RESPOND PREFIX="info" MSG="Предочистка закончена"

[gcode_macro _START_PRECLEAR]
description: Предочистка сопла
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28 Z                    ; Идем домой
        M400
        G28 X
        G28 Y
        M400
        M400
    {% endif %}
    _PRE_CLEAR_NOZZLE


[gcode_macro CLEAR_NOZZLE]
description: Очистка сопла
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(230)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}

    RESPOND PREFIX="info" MSG="Запущена родная очистка сопла {extruder_temp}/{bed_temp}"

    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28 Z                    ; Идем домой
        M400
        G28 X
        G28 Y
        M400
        M400
    {% endif %}

    G90                      ; Абсолютные координаты 
    M82                      ; Абсолютные координаты экструдера

    ;M104 S0 T0               ; Сбрасываем температуру
    ;M140 S0

    G1 Z50 F6000             ; Поднимаем стол

    G1 X-20 Y111 F6000       ; Зависаем по центру
    G1 Z5 F3000
    M400

    LOAD_CELL_TARE           ; Сбрасываем тензодатчики

    M140 S{bed_temp}         ; Греем стол
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp-3} MAXIMUM={bed_temp+4}
    M104 S{extruder_temp} T0 ; Греем экструдер
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp-2} MAXIMUM={extruder_temp+4}

    {% set zpreclear = printer.save_variables.variables.preclear|default(0) | int %}
    {% if zpreclear == 1 %}
        _PRE_CLEAR_NOZZLE
    {% endif %}

    LOAD_CELL_TARE           ; Сбрасываем тензодатчики

#    PROBE_CALIBRATE          ; Замеряем Z-Offset. ;Не испрользуем, т.к. нет возможности считать значение калибровки
#    ABORT                    ; но не сохраняем.
    PROBE                    ; Замеряем Z-Offset
    G1 Z3.5 F3000            ; Поднимаем стол, почти так, как делает PROBE_CALIBRATE

    _CLEAR_NOZZLE

    M104 S120 T0             ; Снижаем температуру до 120 градусов
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={118} MAXIMUM={123}

    G1 X-20 Y107 F1200       ; Убираем сопло от стола
    M400
    G1 Z5 F6000
    M400

    LOAD_CELL_TARE           ; Сбрасываем тензодатчики

[gcode_macro _FULL_BED_LEVEL]
description: Калибровка стола без выключения температуры
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(240)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}
    {% set profile = params.PROFILE|default("auto") %}

    RESPOND PREFIX="info" MSG="Калибровка стола. Профиль {profile}. {extruder_temp}/{bed_temp}"

    BED_MESH_CLEAR          ; Очистка профиля стола
    M400

    CLEAR_NOZZLE EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp}

    # Начинаем калибровку
    _BED_MESH_CALIBRATE PROFILE="{profile}"

    ;G1 Z100 F3000
    G1 X100 Y105            ; Угоняем в угол
    G1 Z-0.02 F3000
    M400

    M106 S0                 ; Отключить кулер
    M107                    ; Отключить кулер экструдера

[gcode_macro AUTO_FULL_BED_LEVEL]
description: Калибровка стола c выключением температуры
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(240)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}
    {% set profile = params.PROFILE|default("auto") %}

    _FULL_BED_LEVEL EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp} PROFILE={profile}

    # Выклчюаем обогрев
    _STOP

# Калибровка PID стола
[gcode_macro M357]
description: Калибровка PID стола
gcode:
  {% if 'E' in params %}
      PID_CALIBRATE HEATER=heater_bed TARGET={params.E}
  {% else %}
      PID_CALIBRATE HEATER=heater_bed TARGET=80
  {% endif %}

  {% set znew_save_config = printer.save_variables.variables.new_save_config|default(0) | int %}
  {% if znew_save_config == 1 %}
    NEW_SAVE_CONFIG
  {% else %}
    SAVE_CONFIG
  {% endif %}

[gcode_macro PID_TUNE_BED]
description: Калибровка PID стола
gcode:
  {% set temperature = params.TEMPERATURE|default(80) %}
  G28 Z
  M400
  G28 X
  G28 Y
  M400
  M400

  M107
  PID_CALIBRATE HEATER=heater_bed TARGET={temperature}

  {% set znew_save_config = printer.save_variables.variables.new_save_config|default(0) | int %}
  {% if znew_save_config == 1 %}
    NEW_SAVE_CONFIG
  {% else %}
    SAVE_CONFIG
  {% endif %}

# Калибровка PID экструдера
[gcode_macro PID_TUNE_EXTRUDER]
description: Калибровка PID экструдера
gcode:
  {% set temperature = params.TEMPERATURE|default(245) %}
  G28 Z
  M400
  G28 X
  G28 Y
  M400
  M400

  M107
  PID_CALIBRATE HEATER=extruder TARGET={temperature}
  {% set znew_save_config = printer.save_variables.variables.new_save_config|default(0) | int %}
  {% if znew_save_config == 1 %}
    NEW_SAVE_CONFIG
  {% else %}
    SAVE_CONFIG
  {% endif %}

[gcode_macro LOAD_FILAMENT]
variable_load_distance:  125
gcode:
    {% set speed = params.SPEED|default(450) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}

    {% set extruder_temp = printer["gcode_macro M600"].zextruder_temp|float %}
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}

    SAVE_GCODE_STATE NAME=load_state
    G91
    G92 E0
    G1 E{load_distance} F{speed} ; extrude with 7.5mm/s
    RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  75
gcode:
    {% set speed = params.SPEED|default(450) %}

    {% set extruder_temp = printer["gcode_macro M600"].zextruder_temp|float %}
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}

    SAVE_GCODE_STATE NAME=unload_state
    G91
    G92 E0
    G1 E-{unload_distance} F{speed} ; unload
    RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro PURGE_FILAMENT]
variable_purge_distance:  25
gcode:
    {% set speed = params.SPEED|default(450) %}

    {% set extruder_temp = printer["gcode_macro M600"].zextruder_temp|float %}
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}

    SAVE_GCODE_STATE NAME=purge_state
    G91
    G92 E0
    G1 E{purge_distance} F{speed}   ; purge
    RESTORE_GCODE_STATE NAME=purge_state

[gcode_macro LOAD_MATERIAL]
description: Manual filament loading / change
variable_initial_target_temp: 0
gcode:
    # save gcode state
    SAVE_GCODE_STATE NAME=load_material_state
    # save heating state
    SET_GCODE_VARIABLE MACRO=LOAD_MATERIAL VARIABLE=initial_target_temp VALUE={printer["extruder"].target}

    _LOAD_MATERIAL_SELECT

[gcode_macro _LOAD_MATERIAL_SELECT]
gcode:
    {% if not printer["extruder"].target >= printer.configfile.settings['extruder'].min_extrude_temp %}
        # material selection
        RESPOND TYPE=command MSG="action:prompt_begin Выбор материала"
        RESPOND TYPE=command MSG="action:prompt_text Какой материал загружать."
        RESPOND TYPE=command MSG="action:prompt_button_group_start"
        RESPOND TYPE=command MSG="action:prompt_button PLA|_LOAD_MATERIAL_HEATUP TEMP=210|primary"
        RESPOND TYPE=command MSG="action:prompt_button PETG|_LOAD_MATERIAL_HEATUP TEMP=240|primary"
        RESPOND TYPE=command MSG="action:prompt_button ABS|_LOAD_MATERIAL_HEATUP TEMP=250|primary"
        RESPOND TYPE=command MSG="action:prompt_button_group_end"
        RESPOND TYPE=command MSG="action:prompt_footer_button Отмена|_LOAD_MATERIAL_END"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% else %}
        # skip preheating dialog, but wait for target temp
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={printer["extruder"].target}
        _LOAD_MATERIAL_ACTION
    {% endif %}

[gcode_macro _LOAD_MATERIAL_HEATUP]
gcode:
    {% set extruder_temp = params.TEMP|default(200)|float %}
    M104 S{extruder_temp}
    RESPOND TYPE=command MSG=action:prompt_end
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}
    _LOAD_MATERIAL_ACTION

[gcode_macro _LOAD_MATERIAL_ACTION]
gcode:
    # loading / unloading
    RESPOND TYPE=command MSG="action:prompt_begin Загрузка филамента"
    RESPOND TYPE=command MSG="action:prompt_text Что сделать?"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Загрузить|LOAD_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button Выгрузить|UNLOAD_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button Очистить|PURGE_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_footer_button Ок|_LOAD_MATERIAL_END"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _LOAD_MATERIAL_END]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"
    # restore old temp
    M104 S{printer["gcode_macro LOAD_MATERIAL"].initial_target_temp}
    # restore gcode state
    RESTORE_GCODE_STATE NAME=load_material_state

[gcode_macro M600]
description: Пауза и смена филамента
variable_zextruder_temp: 240.0
gcode:
    {% set extruder_temp = printer[printer.toolhead.extruder].target if printer.toolhead.extruder != '' else 240.0 %}
    SET_GCODE_VARIABLE MACRO=M600 VARIABLE=zextruder_temp VALUE={extruder_temp|float}

    RESPOND PREFIX="info" MSG="Температура сопла {extruder_temp}"

    PAUSE

    RESPOND TYPE=command MSG="action:prompt_begin Замена филамента"
    RESPOND TYPE=command MSG="action:prompt_text Запрошена замена нити. Загрузите новую нить и нажмите «возобновить»."
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Загрузить|LOAD_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button Выгрузить|UNLOAD_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button Очистить|PURGE_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_footer_button Возобновить|_INTERACTIVE_LOAD_END"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _INTERACTIVE_LOAD_END]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"
    RESUME

[gcode_shell_command sync]
command: sync
timeout: 3
verbose: False

[gcode_shell_command reboot]
command: reboot
timeout: 3
verbose: False

[gcode_shell_command fix_config]
command: /opt/config/mod/.shell/fix_config.sh
timeout: 5
verbose: False

[gcode_shell_command poweroff]
command: poweroff
timeout: 3
verbose: False

[gcode_macro SHUTDOWN]
description: Выключить принтер
gcode:
    BED_MESH_CLEAR
    M400
    # Reset button state, otherwise only one trigger can occur
    SET_PIN PIN=clear_power_off VALUE=1
    # There is a deboucing circuit which needs some delay
    G4 P500
    # Disable pin again otherwise on reset the button will be triggered 1-3 times
    SET_PIN PIN=clear_power_off VALUE=0
    RUN_SHELL_COMMAND CMD=fix_config
    RUN_SHELL_COMMAND CMD=sync
    RUN_SHELL_COMMAND CMD=poweroff

[gcode_macro REBOOT]
description: Перезагрузить принтер
gcode:
    BED_MESH_CLEAR
    M400
    # Reset button state, otherwise only one trigger can occur
    SET_PIN PIN=clear_power_off VALUE=1
    # There is a deboucing circuit which needs some delay
    G4 P500
    # Disable pin again otherwise on reset the button will be triggered 1-3 times
    SET_PIN PIN=clear_power_off VALUE=0
    RUN_SHELL_COMMAND CMD=fix_config
    RUN_SHELL_COMMAND CMD=sync
    RUN_SHELL_COMMAND CMD=reboot

[gcode_shell_command ztouch]
command: touch
timeout: 5
verbose: True

[gcode_macro REMOVE_ZMOD]
description: Удалить zmod
gcode:
    RUN_SHELL_COMMAND CMD=ztouch PARAMS="/opt/config/mod/REMOVE"
    RUN_SHELL_COMMAND CMD=sync
    RUN_SHELL_COMMAND CMD=reboot

[gcode_macro SKIP_ZMOD]
description: Перезагрузка в оригинальную систему. Без запуска zmod.
gcode:
    RUN_SHELL_COMMAND CMD=ztouch PARAMS="/opt/config/mod/SKIP_ZMOD"
    RUN_SHELL_COMMAND CMD=sync
    RUN_SHELL_COMMAND CMD=reboot

[gcode_macro SOFT_REMOVE]
description: Удалить zmod. Не удалять root, audio, md5
gcode:
    RUN_SHELL_COMMAND CMD=ztouch PARAMS="/opt/config/mod/SOFT_REMOVE"
    RUN_SHELL_COMMAND CMD=sync
    RUN_SHELL_COMMAND CMD=reboot

[gcode_macro LED_ON]
description: Включить подсветку
gcode:
    SET_LED LED=chamber_led WHITE=1

[gcode_macro LED_OFF]
description: Выключить подсветку
gcode:
    SET_LED LED=chamber_led WHITE=0

[gcode_macro LED]
description: Включить подсветку на несколько процентов
gcode:
    {% set S = params.S|default(50)|int %}
    SAVE_VARIABLE VARIABLE=led VALUE={S}
    SET_LED LED=chamber_led WHITE={S/100|float}

[gcode_shell_command zdisplay]
command: /root/printer_data/scripts/zdisplay.sh
timeout: 5
verbose: False

[gcode_shell_command zfix_e0017]
command: /root/printer_data/scripts/zfix_e0017.sh
timeout: 50
verbose: True

[gcode_macro DISPLAY_ON]
description: Включить стандартный экран и перезагрузить принтер
gcode:
    RUN_SHELL_COMMAND CMD=zdisplay PARAMS="on"

[gcode_macro DISPLAY_OFF]
description: Выключить стандартный экран
gcode:
    RESPOND PREFIX="info" MSG="Не отключайте экран, если вы четко не понимаете как работает карта стола, z-offset и макросы START_PRINT и END_PRINT"
    RESPOND PREFIX="info" MSG="https://github.com/ghzserg/zmod/wiki/FAQ"

    RUN_SHELL_COMMAND CMD=zdisplay PARAMS="off"
    RESTART

[gcode_shell_command zmem]
command: /root/printer_data/scripts/zmem.sh
timeout: 5
verbose: True

[gcode_macro MEM]
description: Посмотреть расход памяти
gcode:
    RUN_SHELL_COMMAND CMD=zmem

[gcode_macro AIR_CIRCULATION_INTERNAL]
description: Turn on internal air circulation
gcode:
    SET_FAN_SPEED FAN=external_fan SPEED=0
    SET_FAN_SPEED FAN=internal_fan SPEED=1
    SET_SERVO SERVO=my_servo ANGLE=95

[gcode_macro AIR_CIRCULATION_EXTERNAL]
description: Turn on external air circulation
gcode:
    SET_FAN_SPEED FAN=external_fan SPEED=.8 ;dropped to 80 percent to quiet it down
    SET_FAN_SPEED FAN=internal_fan SPEED=1
    SET_SERVO SERVO=my_servo ANGLE=180

[gcode_macro AIR_CIRCULATION_STOP]
description: Turn off air circulation
gcode:
    SET_FAN_SPEED FAN=external_fan SPEED=0
    SET_FAN_SPEED FAN=internal_fan SPEED=0
    SET_SERVO SERVO=my_servo ANGLE=95

[gcode_shell_command audio_midi]
command: audio_midi.sh
timeout: 30
verbose: True

[gcode_macro PLAY_MIDI]
description: Проиграть MIDI файл
gcode:
    {% set FILE = params.FILE|default("For_Elise.mid")|string %}
    RUN_SHELL_COMMAND CMD=audio_midi PARAMS="{FILE}"

[gcode_shell_command zcamera]
command: /root/printer_data/scripts/zcamera.sh
timeout: 5
verbose: True

[gcode_macro CAMERA_ON]
description: Использовать альтернативную реализацию камеры
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin Отключите камеру на экране принтера"
    RESPOND TYPE=command MSG="action:prompt_end"
    RESPOND TYPE=command MSG="action:prompt_show"
    {% set WIDTH  = params.WIDTH|default(640)|int %}
    {% set HEIGHT = params.HEIGHT|default(480)|int %}
    {% set FPS    = params.FPS|default(20)|int %}
    {% set VIDEO  = params.VIDEO|default("video0")|string %}
    RUN_SHELL_COMMAND CMD=zcamera PARAMS="on {WIDTH} {HEIGHT} {FPS} {VIDEO} RESTART"

[gcode_macro CAMERA_OFF]
description: Отключить альтернативную реализацию камеры
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin Включите камеру на экране принтера"
    RESPOND TYPE=command MSG="action:prompt_end"
    RESPOND TYPE=command MSG="action:prompt_show"
    {% set WIDTH  = params.WIDTH|default(640)|int %}
    {% set HEIGHT = params.HEIGHT|default(480)|int %}
    {% set FPS    = params.FPS|default(20)|int %}
    {% set VIDEO  = params.VIDEO|default("video0")|string %}
    RUN_SHELL_COMMAND CMD=zcamera PARAMS="off {WIDTH} {HEIGHT} {FPS} {VIDEO} RESTART"

[gcode_shell_command date]
command: date
timeout: 30
verbose: True

[gcode_macro DATE_GET]
description: Посмотреть время
gcode:
    {% set DT  = params.DT|default("")|string %}
    RUN_SHELL_COMMAND CMD=date

[gcode_macro DATE_SET]
description: Установить дату и время в формате 2024.01.01-00:00:00
gcode:
    {% set DT  = params.DT|default("2024.01.01-00:00:00")|string %}
    RUN_SHELL_COMMAND CMD=date PARAMS="date {DT}"

[gcode_shell_command zhttp]
command: /root/printer_data/scripts/zhttp.sh
timeout: 5
verbose: False

[gcode_macro WEB]
description: Сменить веб интерфейс fluidd/mainsail
gcode:
    RUN_SHELL_COMMAND CMD=zhttp

[gcode_macro _G17]
gcode:
    RESPOND PREFIX="info" MSG="Замените Cпиральный/Автоматич. Z-Hop. Принтер его не поддерживает."
    RESPOND PREFIX="info" MSG="В Orca. Профиль принтера -> Экструдер 1 -> Тип подъема оси Z. Установите Обычный или Наклонный."

[gcode_macro G17]
gcode:
    _G17

[gcode_macro G18]
gcode:
    _G17

[gcode_macro G19]
gcode:
    _G17

[gcode_macro _STOP]
description: Отключить нагрев и кулер
gcode:
    M400
    M220 S100               ; Скорость 100%
    M221 S100               ; Экструзия 100%
    M140 S0                 ; Отключить нагрев стола
    M104 S0                 ; Отключить нагрев экструдера
    M106 S0                 ; Отключить кулер
    M107                    ; Отключить кулер экструдера
    SET_SKEW CLEAR=1        ; reset skew profile if loaded

    {% set zmidi_end = printer.save_variables.variables.midi_end|default("") | string %}
    {% if zmidi_end != "" %}
        PLAY_MIDI FILE={zmidi_end}
    {% endif %}
    EXCLUDE_OBJECT_DEFINE RESET=1

    RESPOND PREFIX="info" MSG="Печать завершена"

[gcode_shell_command zrm]
command: /root/printer_data/scripts/zrm.sh
timeout: 5
verbose: False

[gcode_shell_command zcp]
command: /root/printer_data/scripts/zcp.sh
timeout: 5
verbose: False

[gcode_shell_command zshaper]
command: /root/printer_data/scripts/zshaper.sh
timeout: 600
verbose: True

[gcode_macro ZSHAPER]
description: Калибровка шейперов
gcode:
    RUN_SHELL_COMMAND CMD=zrm

    G28 Z
    M400
    G28 X
    G28 Y
    M400
    M400

    SHAPER_CALIBRATE

    RUN_SHELL_COMMAND CMD=zcp

    RESPOND PREFIX="info" MSG="Шейперы лежат во вкладке Конфигурация -> mod_data."
    RESPOND PREFIX="info" MSG="Скачайте оттуда csv файлы."
    RESPOND PREFIX="info" MSG="Программа для построения графиков."
    RESPOND PREFIX="info" MSG="https://github.com/theycallmek/Klipper-Input-Shaping-Assistant/releases"

    RUN_SHELL_COMMAND CMD=zshaper
    RESPOND PREFIX="info" MSG="Изображения лежат во вкладке Конфигурация -> mod_data. calibration_data_x.png и calibration_data_y.png."

[gcode_shell_command ls]
command: ls
timeout: 5
verbose: True

[gcode_shell_command ln]
command: ln
timeout: 5
verbose: True

[gcode_shell_command rm]
command: rm
timeout: 5
verbose: True

[gcode_macro SET_TIMEZONE]
description: Смена часового пояса
gcode:
    {% set ZONE  = params.ZONE|default("Europe/Moscow")|string %}
    RESPOND PREFIX="info" MSG="Доступные зоны Europe/."
    RUN_SHELL_COMMAND CMD=ls PARAMS="/usr/share/zoneinfo/Europe"
    RESPOND PREFIX="info" MSG="Доступные зоны Asia/."
    RUN_SHELL_COMMAND CMD=ls PARAMS="/usr/share/zoneinfo/Asia"
    RESPOND PREFIX="info" MSG="Использование SET_TIMEZONE ZONE=Asia/Yekaterinburg"
    RUN_SHELL_COMMAND CMD=rm PARAMS="/etc/localtime"
    RUN_SHELL_COMMAND CMD=ln PARAMS="-s /usr/share/zoneinfo/{ZONE} /etc/localtime"
    RUN_SHELL_COMMAND CMD=date

[include ./KAMP/KAMP_Settings.cfg]

[gcode_macro KAMP]
description: Адаптивная кровать
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(240)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}

    BED_MESH_CLEAR          ; Очистка профиля стола
    M400

    CLEAR_NOZZLE EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp}

    _KAMP_BED_MESH_CALIBRATE

    M106 S0                 ; Отключить кулер
    M107                    ; Отключить кулер экструдера

    G1 X100 Y105            ; Угоняем в угол
    G1 Z10 F3000
    M400

    M190 S{bed_temp}
    M109 S{extruder_temp}

[gcode_shell_command tar]
command: tar
timeout: 5
verbose: True

[gcode_macro TAR_CONFIG]
description: Сохраняет файлы конфигурации в архив
gcode:
    RUN_SHELL_COMMAND CMD=tar PARAMS="-cf /opt/config/mod_data/config.tar --exclude ssh.key --exclude .git --exclude .shell --exclude config.tar /opt/klipper/klippy/toolhead.py /opt/config/ /data/logFiles/zmod.log /data/logFiles/zmod.log.1 /data/logFiles/zmod.log.2 /data/logFiles/zmod.log.3 /data/logFiles/zmod.log.4 /data/logFiles/zmod.log.5 /data/logFiles/firmwareExe.log /data/logFiles/meminfo.complete.log /data/logFiles/printer.log /data/logFiles/ssh.log /data/logFiles/moonraker.log /data/logFiles/ffstartup-arm.log /data/logFiles/dmesg.complete.log"
    RESPOND PREFIX="info" MSG="Скачать архив можно в 'Конфигурация' -> 'mod_data' -> config.tar"

[gcode_shell_command stop_zmod]
command: /etc/init.d/S99moon
timeout: 15
verbose: True

[gcode_macro STOP_ZMOD]
description: Остановить fluidd/mainsail и moonraker
gcode:
    RUN_SHELL_COMMAND CMD=stop_zmod PARAMS="stop"

[gcode_macro START_ZMOD]
description: Запустить fluidd/mainsail и moonraker после STOP_ZMOD
gcode:
    RUN_SHELL_COMMAND CMD=stop_zmod PARAMS="up"

[gcode_macro TEST_EMMC]
description: Протестировать EMMC
gcode:
    {% set size    = params.SIZE|default(400)|int %}
    {% set sync    = params.SYNC|default(1)|int %}
    {% set flash   = params.FLASH|default(0)|int %}
    {% set random  = params.RANDOM|default(0)|int %}

    RUN_SHELL_COMMAND CMD=zfs PARAMS="{size} {sync} {flash} {random}"

[gcode_macro CLEAR_EMMC]
description: Очистить EMMC
gcode:
    {% set log    = params.LOG|default(1)|int %}
    {% set any    = params.ANY|default(0)|int %}

    RUN_SHELL_COMMAND CMD=zclear PARAMS="{log} {any}"

[gcode_shell_command zfs]
command: /root/printer_data/scripts/zfs.sh
timeout: 600
verbose: True

[gcode_shell_command zclear]
command: /root/printer_data/scripts/zclear.sh
timeout: 600
verbose: False

[gcode_shell_command zssh]
command: /root/printer_data/scripts/zssh.sh
timeout: 60
verbose: True

[gcode_macro ZSSH_ON]
description: Перенаправить moonraker и камеру на SSH сервер
gcode:
    {% set ssh_server  = params.SSH_SERVER|default("127.0.0.1")|string %}
    {% set ssh_port    = params.SSH_PORT|default(22)|int %}
    {% set ssh_user    = params.SSH_USER|default("user")|string %}
    {% set video_port  = params.VIDEO_PORT|default(8080)|int %}
    {% set moon_port   = params.MOON_PORT|default(7125)|int %}
    {% set remote_run  = params.REMOTE_RUN|default("NONE")|string %}
    RUN_SHELL_COMMAND CMD=zssh PARAMS="START {ssh_server} {ssh_port} {ssh_user} {video_port} {moon_port} '{remote_run}' RESTART"

[gcode_macro ZSSH_OFF]
description: Отключить проброс портов SSH
gcode:
    RUN_SHELL_COMMAND CMD=zssh PARAMS="STOP 127.0.0.1 22 user 8080 7125 NONE RESTART"

[gcode_macro ZSSH_RESTART]
description: Перезапуск SSH
gcode:
    RUN_SHELL_COMMAND CMD=zssh PARAMS="RESTART 127.0.0.1 22 user 8080 7125 NONE RESTART"

[gcode_macro ZSSH_RELOAD]
description: Запуск SSH, если он не запущен
gcode:
    {% set screen = printer["gcode_macro START_PRINT"].screen %}
    {% if screen == True %}
        RESPOND PREFIX="info" MSG="Вы работаете с родным экраном"
    {% else %}
        RESPOND PREFIX="info" MSG="Вы работаете БЕЗ экрана"
    {% endif %}
    RUN_SHELL_COMMAND CMD=zssh PARAMS="RELOAD 127.0.0.1 22 user 8080 7125 NONE RESTART"

[gcode_macro _CLEAR1]
description: Код очистки из Orca Slicer
gcode:
    G90
    M83
    G1 Z5 F6000
    G1 E-0.2 F800
    G1 X110 Y-110 F6000
    G1 E2 F800
    G1 Y-110 X55 Z0.25 F4800
    G1 X-55 E8 F2400
    G1 Y-109.6 F2400
    G1 X55 E5 F2400
    G1 Y-110 X55 Z0.45 F4800
    G1 X-55 E8 F2400
    G1 Y-109.6 F2400
    G1 X55 E5 F2400
    G92 E0

[gcode_macro _CLEAR2]
description: Код очистки из группы FF
gcode:
    G90
    M83
    G1 E-0.2 F800
    G1 X110 Y-110 Z5 F6000
    G1 Z0.2 F1200
    G1 E2 F800
    G1 X20 E9 F1000
    G1 X-60 E12.5 F1000
    G1 E-0.2 F800
    G92 E0

[gcode_macro _CLEAR3]
description: Код очистки из группы FF2
gcode:
    G90
    M83
    G1 Y-110 X80 Z0.2 F4800
    G1 X20 E9 F1000 ; intro line
    G1 X-60 E12.5 F1000 ; intro line
    G92 E0

[gcode_macro _CLEAR4]
description: Код очистки от Шрейдера справа сверху-вниз
gcode:
    G90
    M83
    G1 Z5 F6000
    G1 E-1.5 F800
    G1 X110 Y41 F6000
    G1 E2 F800
    G1 Y41 Z0.2 F4800
    G1 Y-39 E9 F1000 ; intro line
    G1 Y-99 E12.5 F1000 ; intro line
    G92 E0

[gcode_macro _START_MESH]
gcode:
    {% set extruder_temp = printer["gcode_macro _START_PRINT"].zextruder_temp|float %}  ; extruder temp, usually set by slicer
    {% set bed_temp = printer["gcode_macro _START_PRINT"].zbed_temp|float %}            ; bed temp, usually set by slicer
    {% set skip_leveling = printer["gcode_macro _START_PRINT"].zskip_leveling %}        ; Не строить карту
    {% set force_kamp = printer["gcode_macro _START_PRINT"].zforce_kamp %}              ; if True it forces the KAMP bed level process
    {% set force_leveling = printer["gcode_macro _START_PRINT"].zforce_leveling %}      ; if True it forces the bed level process
    {% set mesh = printer["gcode_macro _START_PRINT"].zmesh %}                          ; Имя профиля карты стола

    {%if skip_leveling == False %}
        {%if force_kamp == True %}
            RESPOND PREFIX="//" MSG="Запущен KAMP SKIP_LEVELING={skip_leveling} FORCE_KAMP={force_kamp}"
            {% set screen = printer["gcode_macro START_PRINT"].screen %}
            {% if screen == True %}
                RESPOND PREFIX="info" MSG="А вы знали, что можно прописать запуск KAMP глобально?"
                RESPOND PREFIX="//" MSG="SAVE_ZMOD_DATA USE_KAMP=1 CLEAR=LINE_PURGE"
            {% endif %}
            KAMP BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}
        {% else %}
            {%if (not printer['bed_mesh'].profile_name) or force_leveling == True %}
                {% if mesh != "" %}
                    RESPOND PREFIX="!!" MSG="Запущено построение карты стола {mesh}, т.к. она не найдена"
                    RESPOND PREFIX="!!" MSG="Сохраните ее ПОСЛЕ печати"
                    _FULL_BED_LEVEL BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp} PROFILE={mesh}
                {% else %}
                    {%if force_leveling == True %}
                        RESPOND PREFIX="info" MSG="Запущено построение карты стола (FORCE_LEVELING={force_leveling})"
                    {% else %}
                        RESPOND PREFIX="info" MSG="Запущено построение карты стола auto, т.к. не загружена ни одна карта"
                    {% endif %}
                    _FULL_BED_LEVEL BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}
                {% endif %}
            {% endif %}
            {% set cur_mesh = printer['bed_mesh'].profile_name %}
            RESPOND PREFIX="//" MSG="Нет необходимости строить карту стола. Загружен профиль {cur_mesh}."
        {% endif %}
    {% else %}
        RESPOND PREFIX="//" MSG="Карта стола не строится. SKIP_LEVELING={skip_leveling}"
    {% endif %}

[gcode_macro _START_PRINT]
description: Замена стандартного стартового G-code
variable_zextruder_temp: 245.0
variable_zbed_temp: 80.0
variable_zforce_kamp: False
variable_zforce_leveling: False
variable_zskip_leveling: False
variable_zskip_zoffset: False
variable_zzoffset: 0.0
variable_zmesh: ""
gcode:
    {% set force_kamp = printer["gcode_macro _START_PRINT"].zforce_kamp %}              ; if True it forces the KAMP bed level process
    {% set extruder_temp = printer["gcode_macro _START_PRINT"].zextruder_temp|float %}  ; extruder temp, usually set by slicer
    {% set bed_temp = printer["gcode_macro _START_PRINT"].zbed_temp|float %}            ; bed temp, usually set by slicer
    {% set force_leveling = printer["gcode_macro _START_PRINT"].zforce_leveling %}      ; if True it forces the bed level process
    {% set zoffset = printer["gcode_macro _START_PRINT"].zzoffset %}                    ; Установить Z offset
    {% set skip_zoffset = printer["gcode_macro _START_PRINT"].zskip_zoffset %}          ; Для печати с родного экрана не устанавливать Z offset
    {% set skip_leveling = printer["gcode_macro _START_PRINT"].zskip_leveling %}        ; Не строить карту
    {% set mesh = printer["gcode_macro _START_PRINT"].zmesh %}                          ; Имя профиля карты стола

    {% set force_md5 = printer.save_variables.variables.force_md5|default(1) | int %}
    {% set disable_priming = printer.save_variables.variables.disable_priming|default(0) | int %}
    {% set disable_skew = printer.save_variables.variables.disable_skew|default(1) | int %}
    {% set load_zoffset = printer.save_variables.variables.load_zoffset|default(0) | int %}
    {% set zclear = printer.save_variables.variables.zclear|default("LINE_PURGE")|string %}
    {% set zuse_kamp = printer.save_variables.variables.use_kamp|default(0) | int %}

    ZSSH_RELOAD

    {% set screen = printer["gcode_macro START_PRINT"].screen %}
    {% if screen == True %}
        RESPOND PREFIX="info" MSG="Вы работаете с родным экраном"
    {% else %}
        RESPOND PREFIX="info" MSG="Вы работаете БЕЗ экрана"
    {% endif %}

    RESPOND PREFIX="info" MSG="START_PRINT BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp} FORCE_LEVELING={force_leveling} FORCE_KAMP={force_kamp} Z_OFFSET={zoffset} SKIP_ZOFFSET={skip_zoffset} SKIP_LEVELING={skip_leveling} MESH={mesh}"
    RESPOND PREFIX="info" MSG="Температура экструдера: {extruder_temp}"
    RESPOND PREFIX="info" MSG="Температура стола: {bed_temp}"
    {%if force_kamp == True %}
        RESPOND PREFIX="info" MSG="KAMP: включено"
    {% else %}
        RESPOND PREFIX="info" MSG="KAMP: выключено"
    {% endif %}
    {%if force_md5 == 1 %}
        RESPOND PREFIX="info" MSG="MD5: включено"
    {% else %}
        RESPOND PREFIX="info" MSG="MD5: выключено"
    {% endif %}
    {%if force_leveling == True %}
        RESPOND PREFIX="info" MSG="Снятие карты стола принудительно: включено"
    {% else %}
        RESPOND PREFIX="info" MSG="Снятие карты стола принудительно: выключено"
    {% endif %}
    {%if skip_leveling == True %}
        RESPOND PREFIX="info" MSG="Не снимать карту стола: включено"
    {% else %}
        RESPOND PREFIX="info" MSG="Не снимать карту стола: выключено"
    {% endif %}
    {%if disable_priming == 1 %}
        RESPOND PREFIX="info" MSG="Очистка сопла линией: выключено"
    {% else %}
        RESPOND PREFIX="info" MSG="Очистка сопла линией: включено"
    {% endif %}
    {%if disable_skew == 1 %}
        RESPOND PREFIX="info" MSG="SKEW: выключен"
    {% else %}
        RESPOND PREFIX="info" MSG="SKEW: включен"
    {% endif %}
    {%if load_zoffset == 1 %}
        RESPOND PREFIX="info" MSG="Глобальная загрузка Z-OFFSET: включено"
    {% else %}
        RESPOND PREFIX="info" MSG="Глобальная загрузка Z-OFFSET: выключено"
    {% endif %}
    {%if skip_zoffset == True %}
        RESPOND PREFIX="info" MSG="Установить Z-OFFESET: выключен"
    {% else %}
        RESPOND PREFIX="info" MSG="Установить Z-OFFESET: включен"
    {% endif %}
    RESPOND PREFIX="info" MSG="Z-Offset: {zoffset}"
    RESPOND PREFIX="info" MSG="Подгружать карту стола: {mesh}"
    RESPOND PREFIX="info" MSG="Алгоритм очистки: {zclear}"

    {%if force_md5 == 1 %}
        RESPOND PREFIX="info" MSG="Запущена проверка MD5"
#        CHECK_MD5 DELETE=True
        CHECK_MD5 DELETE=False
    {% endif %}

    M140 S{bed_temp}        ; start bed heating
    SET_SKEW CLEAR=1        ; reset skew profile if loaded

    {%if load_zoffset == 1 %}
        RESPOND PREFIX="info" MSG="Используется глобальное управление Z-Offset. Параметры SKIP_ZOFFSET и Z_OFFSET игнорируются"
        LOAD_GCODE_OFFSET
    {% else %}
        {%if skip_zoffset == True %}
            RESPOND PREFIX="info" MSG="Установка Z-offset пропущена, SKIP_ZOFFSET={skip_zoffset}"
        {% else %}
            RESPOND PREFIX="info" MSG="Установка Z-offset {zoffset}, SKIP_ZOFFSET={skip_zoffset}"
            SET_GCODE_OFFSET Z={zoffset}
        {% endif %}
    {% endif %}

    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28 Z                    ; Идем домой
        M400
        G28 X
        G28 Y
        M400
        M400
    {% endif %}

    {% set zprint_leveling = printer.save_variables.variables.print_leveling|default(0) | int %}
    {% if zprint_leveling == 1 %}
        {% if screen == True %}
            RESPOND PREFIX="//" MSG="При каждой печати строить карту стола средствами родного экрана. // SAVE_ZMOD_DATA PRINT_LEVELING={zprint_leveling}"
        {% else %}
            RESPOND PREFIX="//" MSG="При каждой печати строить карту стола. // SAVE_ZMOD_DATA PRINT_LEVELING={zprint_leveling}"
            BED_MESH_CLEAR
            M400
            {% if zuse_kamp == 1 %}
                RESPOND PREFIX="info" MSG="Использую KAMP из глобальных параметров. // SAVE_ZMOD_DATA USE_KAMP={zuse_kamp}"
                KAMP BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}
            {% else %}
                RESPOND PREFIX="info" MSG="Строится полная карта стола. // SAVE_ZMOD_DATA USE_KAMP={zuse_kamp}"
                _FULL_BED_LEVEL BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}
            {% endif %}
        {% endif %}

        RESPOND PREFIX="//" MSG="Все параметры START_PRINT для построения карты стола игнорируются"
    {% else %}
        {% if mesh != "" %}
            RESPOND PREFIX="info" MSG="Пробую загрузить карту стола {mesh}"
            BED_MESH_CLEAR
            M400
            {% for mesh_dt in printer['bed_mesh'].profiles %}
                {% if mesh == mesh_dt %}
                    BED_MESH_PROFILE LOAD={mesh}
                    RESPOND PREFIX="info" MSG="Карта стола {mesh} загружена"
                {% endif %}
            {% endfor %}
        {% endif %}

        _START_MESH
    {% endif %}

    G90                     ; use absolute coordinates
    G1 Z10 F1800            ; move the nozzle near the bed
    # wait for bed to reach temp, don't wait for stabilization
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp}
    M109 S{extruder_temp}   ; set and wait for nozzle to reach temperature

    {% set zmidi_start = printer.save_variables.variables.midi_start|default("") | string %}
    {% if zmidi_start != "" %}
        PLAY_MIDI FILE={zmidi_start}
    {% endif %}

    {% if disable_priming == 1 %}
        RESPOND PREFIX="info" MSG="Очистка сопла линией отключена. DISABLE_PRIMING={disable_priming}"
    {% else %}
        RESPOND PREFIX="info" MSG="Очистка сопла линией"
        RESPOND PREFIX="info" MSG="Алгоритм: {zclear}"


        {% if ( (force_kamp == True) or (zuse_kamp == 1) ) and (zclear != "LINE_PURGE" ) %}
            RESPOND PREFIX="info" MSG="У вас используется KAMP. Рекомендуется использовать линию очистки LINE_PURGE: SAVE_ZMOD_DATA CLEAR=LINE_PURGE"
        {% endif %}

        {zclear}
    {% endif %}

    # load skew profile
    {% if disable_skew == 0 %}
        RESPOND PREFIX="info" MSG="Загрузка skew_profile"
        SKEW_PROFILE LOAD=skew_profile
    {% endif %}

[gcode_shell_command restart_klipper]
command: /root/printer_data/scripts/restart_klipper.sh
timeout: 50
verbose: True

[gcode_shell_command close_dialogs]
command: /root/printer_data/scripts/close_dialogs.sh
timeout: 50
verbose: True

[gcode_shell_command zprint]
command: /root/printer_data/scripts/zprint.sh
timeout: 50
verbose: True

[gcode_shell_command zversion]
command: /root/printer_data/scripts/zversion.sh
timeout: 5
verbose: True

[gcode_macro NEW_SAVE_CONFIG]
description: Сохранить параметры, без зависания родного экрана
gcode:
    RESPOND PREFIX="info" MSG="Альтернативная реализация SAVE_CONFIG"
    RUN_SHELL_COMMAND CMD=restart_klipper

[gcode_macro CLOSE_DIALOGS]
description: Закрыть диалоговые окна на родном экране (медленно)
gcode:
    RESPOND PREFIX="info" MSG="Закрываю диалоговые окна на родном экране (медленно)"
    RUN_SHELL_COMMAND CMD=close_dialogs

[gcode_macro FAST_CLOSE_DIALOGS]
description: Закрыть диалоговые окна на родном экране (быстро)
gcode:
    RESPOND PREFIX="info" MSG="Закрываю диалоговые окна на родном экране (быстро)"
    RUN_SHELL_COMMAND CMD=zprint PARAMS="CLOSE CLOSE"

[delayed_gcode _STOP_MOTOR]
gcode:
    RESPOND PREFIX="info" MSG="Моторы отключены"
    M84                     ; Выключить мотор

[delayed_gcode _GOTO_PAUSE]
gcode:
    G1 Y108 F7800
    G1 X108 F7800

[delayed_gcode _CLOSE_DIALOGS]
gcode:
    CLOSE_DIALOGS

[delayed_gcode _FAST_CLOSE_DIALOGS]
gcode:
    FAST_CLOSE_DIALOGS

[delayed_gcode _AUTO_REBOOT]
gcode:
    REBOOT

[delayed_gcode restart_services]
initial_duration: 180
gcode:
    RUN_SHELL_COMMAND CMD=zdisplay PARAMS="test"
    ZSSH_RELOAD

[delayed_gcode start_led]
initial_duration: 10
gcode:
    GET_ZMOD_DATA

    {% set zmidi_on = printer.save_variables.variables.midi_on|default("") | string %}
    {% if zmidi_on != "" %}
        PLAY_MIDI FILE={zmidi_on}
    {% endif %}

    {% set zled = printer.save_variables.variables.led|default(50) | int %}
    LED S={zled}

[gcode_macro _COLDPULL_LOAD_MATERIAL_END]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"

[gcode_macro _COLDPULL_LOAD_MATERIAL]
gcode:
    RESPOND TYPE=command MSG=action:prompt_end

    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28 Z                    ; Идем домой
        M400
        G28 X
        G28 Y
        M400
        M400
    {% endif %}

    G90
    G1 X0 F7800
    G1 Y0 F7800
    M400
    M400

    {% set extruder_temp = params.TEMP|default(245)|float %}
    RESPOND PREFIX="info" MSG="Ждем нагревани сопла до {extruder_temp} градусов"
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp} MAXIMUM={extruder_temp+10}

    RESPOND PREFIX="info" MSG="Пропускаем 10 см пластика"
    G1 E100 F100
    M400

    {% set cold_temp = params.COLD|default(245)|float %}
    RESPOND PREFIX="info" MSG="Остужаем до {cold_temp} градусов"
    M104 S{cold_temp}
    M106 P0 S255
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={cold_temp-2} MAXIMUM={cold_temp+2}

    RESPOND PREFIX="info" MSG="Дергаем пруток"
    G1 E-70 F1500
    M400

    RESPOND PREFIX="info" MSG="Вытащите остаток прутка руками"
    M107
    M104 S0

[gcode_macro COLDPULL]
description: Колдпул (очистка сопла) без насилия.
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin Выбор материала для загрузки"
    RESPOND TYPE=command MSG="action:prompt_text Выберите каким материлом чистить сопло."
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button PETG|_COLDPULL_LOAD_MATERIAL TEMP=245 COLD=100|primary"
    RESPOND TYPE=command MSG="action:prompt_button ABS|_COLDPULL_LOAD_MATERIAL TEMP=255 COLD=105|primary"
    RESPOND TYPE=command MSG="action:prompt_button NEYLON|_COLDPULL_LOAD_MATERIAL TEMP=260 COLD=120|primary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_footer_button Отмена|_COLDPULL_LOAD_MATERIAL_END"
    RESPOND TYPE=command MSG="action:prompt_show"


[gcode_macro SAVE_ZMOD_DATA]
description: Сохранить параметры ZMOD
gcode:
    {% if params.CLOSE_DIALOGS %}
        {% set zclose_dialogs = params.CLOSE_DIALOGS|default(0)|int %}
        SAVE_VARIABLE VARIABLE=close_dialogs VALUE={zclose_dialogs|int}
    {% endif %}

    {% if params.STOP_MOTOR %}
        {% set zstop_motor = params.STOP_MOTOR|default(1)|int %}
        SAVE_VARIABLE VARIABLE=stop_motor VALUE={zstop_motor|int}
    {% endif %}

    {% if params.USE_SWAP %}
        {% set zuse_swap = params.USE_SWAP|default(1)|int %}
        SAVE_VARIABLE VARIABLE=use_swap VALUE={zuse_swap|int}
    {% endif %}

    {% if params.AUTO_REBOOT %}
        {% set zauto_reboot = params.AUTO_REBOOT|default(0)|int %}
        SAVE_VARIABLE VARIABLE=auto_reboot VALUE={zauto_reboot|int}
    {% endif %}

    {% if params.FIX_E0017 %}
        {% set fix_e0017 = params.FIX_E0017|default(1)|int %}
        SAVE_VARIABLE VARIABLE=fix_e0017 VALUE={fix_e0017|int}
    {% endif %}

    {% if params.PRINT_LEVELING %}
        {% set zprint_leveling = params.PRINT_LEVELING|default(0)|int %}
        SAVE_VARIABLE VARIABLE=print_leveling VALUE={zprint_leveling|int}
    {% endif %}

    {% if params.USE_KAMP %}
        {% set zuse_kamp = params.USE_KAMP|default(0)|int %}
        SAVE_VARIABLE VARIABLE=use_kamp VALUE={zuse_kamp|int}
    {% endif %}

    {% if params.NEW_SAVE_CONFIG %}
        {% set znew_save_config = params.NEW_SAVE_CONFIG|default(0)|int %}
        SAVE_VARIABLE VARIABLE=new_save_config VALUE={znew_save_config|int}
    {% endif %}

    {% if params.PRECLEAR %}
        {% set zpreclear = params.PRECLEAR|default(0)|int %}
        SAVE_VARIABLE VARIABLE=preclear VALUE={zpreclear|int}
    {% endif %}

    {% if params.FORCE_MD5 %}
        {% set zforce_md5 = params.FORCE_MD5|default(1)|int %}
        SAVE_VARIABLE VARIABLE=force_md5 VALUE={zforce_md5|int}
    {% endif %}

    {% if params.DISABLE_SKEW %}
        {% set zdisable_skew = params.DISABLE_SKEW|default(1)|int %}
        SAVE_VARIABLE VARIABLE=disable_skew VALUE={zdisable_skew|int}
    {% endif %}

    {% if params.LOAD_ZOFFSET %}
        {% set zload_zoffset = params.LOAD_ZOFFSET|default(0)|int %}
        SAVE_VARIABLE VARIABLE=load_zoffset VALUE={zload_zoffset|int}
    {% endif %}

    {% if params.LED %}
        {% set zled = params.LED|default(50)|int %}
        SAVE_VARIABLE VARIABLE=led VALUE={zled|int}
    {% endif %}

    {% if params.DISABLE_PRIMING %}
        {% set zdisable_priming = params.DISABLE_PRIMING|default(0)|int %}
        SAVE_VARIABLE VARIABLE=disable_priming VALUE={zdisable_priming|int}
    {% endif %}

    {% if params.CLEAR %}
        {% set zclear = params.CLEAR|default("LINE_PURGE")|string %}
        SAVE_VARIABLE VARIABLE=zclear VALUE='"{zclear|string}"'
    {% endif %}

    {% if params.MIDI_ON %}
        {% set zmidi_on = params.MIDI_ON|default("")|string %}
        {% if zmidi_on == "0" %}
            SAVE_VARIABLE VARIABLE=midi_on VALUE='""'
        {% else %}
            SAVE_VARIABLE VARIABLE=midi_on VALUE='"{zmidi_on|string}"'
        {% endif %}
    {% endif %}

    {% if params.MIDI_START %}
        {% set zmidi_start = params.MIDI_START|default("")|string %}
        {% if zmidi_start == "0" %}
            SAVE_VARIABLE VARIABLE=midi_start VALUE='""'
        {% else %}
            SAVE_VARIABLE VARIABLE=midi_start VALUE='"{zmidi_start|string}"'
        {% endif %}
    {% endif %}

    {% if params.MIDI_END %}
        {% set zmidi_end = params.MIDI_END|default("")|string %}
        {% if zmidi_end == "0" %}
            SAVE_VARIABLE VARIABLE=midi_end VALUE='""'
        {% else %}
            SAVE_VARIABLE VARIABLE=midi_end VALUE='"{zmidi_end|string}"'
        {% endif %}
    {% endif %}

    GET_ZMOD_DATA

[gcode_macro GET_ZMOD_DATA]
description: Получить параметры ZMOD
gcode:
    RESPOND PREFIX="info" MSG="Параметры zmod. Задаются через SAVE_ZMOD_DATA"

    {% set screen = printer["gcode_macro START_PRINT"].screen %}
    {% if screen == True %}
        RESPOND PREFIX="info" MSG="Вы работаете с родным экраном"
    {% else %}
        RESPOND PREFIX="info" MSG="Вы работаете БЕЗ экрана"
    {% endif %}

    RESPOND PREFIX="info" MSG="Параметры используемые при начале печати, построении карты стола [START_PRINT]"

    {% set zprint_leveling = printer.save_variables.variables.print_leveling|default(0) | int %}
    {% if zprint_leveling == 1 %}
        {% if screen == True %}
            RESPOND PREFIX="//" MSG="При каждой печати строить карту стола средствами родного экрана. // SAVE_ZMOD_DATA PRINT_LEVELING={zprint_leveling}"
        {% else %}
            RESPOND PREFIX="//" MSG="При каждой печати строить карту стола. // SAVE_ZMOD_DATA PRINT_LEVELING={zprint_leveling}"
        {% endif %}
    {% else %}
        RESPOND PREFIX="//" MSG="Не строить карту стола средствами родного экрана // SAVE_ZMOD_DATA PRINT_LEVELING={zprint_leveling}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=print_leveling VALUE={zprint_leveling|int}

    {% set zuse_kamp = printer.save_variables.variables.use_kamp|default(0) | int %}
    {% if zuse_kamp == 1 %}
        RESPOND PREFIX="//" MSG="Где возможно использовать адаптивную карту стола(KAMP), вместо полной карты стола // SAVE_ZMOD_DATA USE_KAMP={zuse_kamp}"
    {% else %}
        RESPOND PREFIX="//" MSG="Не использоваить KAMP вместо BED_MESH_CALIBRATE // SAVE_ZMOD_DATA USE_KAMP={zuse_kamp}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=use_kamp VALUE={zuse_kamp|int}

    {% set zmidi_start = printer.save_variables.variables.midi_start|default("") | string %}
    RESPOND PREFIX="//" MSG="Играть MIDI при запуске печати: {zmidi_start} // SAVE_ZMOD_DATA MIDI_START={zmidi_start}"
    SAVE_VARIABLE VARIABLE=midi_start VALUE='"{zmidi_start|string}"'

    {% set zforce_md5 = printer.save_variables.variables.force_md5|default(1) | int %}
    {% if zforce_md5 == 1 %}
        RESPOND PREFIX="//" MSG="Проверять MD5 сумму файла // SAVE_ZMOD_DATA FORCE_MD5={zforce_md5}"
    {% else %}
        RESPOND PREFIX="//" MSG="Не проверять MD5 сумму файла // SAVE_ZMOD_DATA FORCE_MD5={zforce_md5}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=force_md5 VALUE={zforce_md5|int}

    {% set zdisable_skew = printer.save_variables.variables.disable_skew|default(1) | int %}
    {% if zdisable_skew == 1 %}
        RESPOND PREFIX="//" MSG="SKEW коррекция отключена // SAVE_ZMOD_DATA DISABLE_SKEW={zdisable_skew}"
    {% else %}
        RESPOND PREFIX="//" MSG="SKEW коррекция включена. Профиль skew_profile // SAVE_ZMOD_DATA DISABLE_SKEW={zdisable_skew}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=disable_skew VALUE={zdisable_skew|int}

    {% set zload_zoffset = printer.save_variables.variables.load_zoffset|default(0) | int %}
    {% if zload_zoffset == 1 %}
        RESPOND PREFIX="//" MSG="Загрузка Z-OFFSET из глобальных параметров // SAVE_ZMOD_DATA LOAD_ZOFFSET={zload_zoffset}"
    {% else %}
        RESPOND PREFIX="//" MSG="Не загружать Z-OFFSET из глобальных параметров // SAVE_ZMOD_DATA LOAD_ZOFFSET={zload_zoffset}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=load_zoffset VALUE={zload_zoffset|int}

    {% set zdisable_priming = printer.save_variables.variables.disable_priming|default(0) | int %}
    {% if zdisable_priming == 1 %}
        RESPOND PREFIX="//" MSG="Выключить очистку сопла лининей // SAVE_ZMOD_DATA DISABLE_PRIMING={zdisable_priming}"
    {% else %}
        RESPOND PREFIX="//" MSG="Включить очистку сопла лининей // SAVE_ZMOD_DATA DISABLE_PRIMING={zdisable_priming}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=disable_priming VALUE={zdisable_priming|int}

    {% set zpreclear = printer.save_variables.variables.preclear|default(0) | int %}
    {% if zpreclear == 1 %}
        RESPOND PREFIX="//" MSG="Использовать предочистку сопла// SAVE_ZMOD_DATA PRECLEAR={zpreclear}"
    {% else %}
        RESPOND PREFIX="//" MSG="Не использовать предочистку сопла// SAVE_ZMOD_DATA PRECLEAR={zpreclear}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=preclear VALUE={zpreclear|int}

    {% set zclear = printer.save_variables.variables.zclear|default("LINE_PURGE") | string %}
    RESPOND PREFIX="//" MSG="Алгоритм очистки: {zclear} // SAVE_ZMOD_DATA CLEAR={zclear}"
    SAVE_VARIABLE VARIABLE=zclear VALUE='"{zclear|string}"'

    RESPOND PREFIX="info" MSG="Параметры используемые при окончании и отмене печати [END_PRINT]"

    {% set zmidi_end = printer.save_variables.variables.midi_end|default("") | string %}
    RESPOND PREFIX="//" MSG="Играть MIDI в конце печати: {zmidi_end} // SAVE_ZMOD_DATA MIDI_END={zmidi_end}"
    SAVE_VARIABLE VARIABLE=midi_end VALUE='"{zmidi_end|string}"'

    {% set zclose_dialogs = printer.save_variables.variables.close_dialogs|default(0) | int %}
    {% if zclose_dialogs == 0 %}
        RESPOND PREFIX="//" MSG="Не закрывать диалоги на родном экране. // SAVE_ZMOD_DATA CLOSE_DIALOGS={zclose_dialogs}"
    {% endif %}
    {% if zclose_dialogs == 1 %}
        RESPOND PREFIX="//" MSG="Автоматически закрывать диалоги на родном экране через 20 секунд (медленно). // SAVE_ZMOD_DATA CLOSE_DIALOGS={zclose_dialogs}"
    {% endif %}
    {% if zclose_dialogs == 2 %}
        RESPOND PREFIX="//" MSG="Автоматически закрывать диалоги на родном экране через 20 секунд (быстро). // SAVE_ZMOD_DATA CLOSE_DIALOGS={zclose_dialogs}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=close_dialogs VALUE={zclose_dialogs|int}

    {% set zstop_motor = printer.save_variables.variables.stop_motor|default(1) | int %}
    {% if zstop_motor == 1 %}
        RESPOND PREFIX="//" MSG="Автоматически выключать моторы после печати/отмены печати через 25 секунд. // SAVE_ZMOD_DATA STOP_MOTOR={zstop_motor}"
    {% else %}
        RESPOND PREFIX="//" MSG="Не выключать моторы автоматически, после печати/отмены печати. // SAVE_ZMOD_DATA STOP_MOTOR={zstop_motor}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=stop_motor VALUE={zstop_motor|int}

    {% set zauto_reboot = printer.save_variables.variables.auto_reboot|default(0) | int %}
    {% if zauto_reboot == 1 %}
        RESPOND PREFIX="//" MSG="Автоматически перезапускать принтер через 1.5 минуты после печати. //SAVE_ZMOD_DATA AUTO_REBOOT={zauto_reboot}"
    {% else %}
        RESPOND PREFIX="//" MSG="Не перезапускать принтер автоматически. // SAVE_ZMOD_DATA AUTO_REBOOT={zauto_reboot}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=auto_reboot VALUE={zauto_reboot|int}

    RESPOND PREFIX="info" MSG="Общесистемные параметры"

    {% set fix_e0017 = printer.save_variables.variables.fix_e0017|default(1) | int %}
    {% if fix_e0017 == 1 %}
        RESPOND PREFIX="//" MSG="Исправить ошибку E0017. // SAVE_ZMOD_DATA FIX_E0017={fix_e0017}"
    {% else %}
        RESPOND PREFIX="//" MSG="Не исправлять ошибку E0017. // SAVE_ZMOD_DATA FIX_E0017={fix_e0017}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=fix_e0017 VALUE={fix_e0017|int}
    RUN_SHELL_COMMAND CMD=zfix_e0017 PARAMS="{fix_e0017}"

    {% set zled = printer.save_variables.variables.led|default(50) | int %}
    RESPOND PREFIX="//" MSG="Яркость LED при включении {zled} // SAVE_ZMOD_DATA LED={zled}"
    SAVE_VARIABLE VARIABLE=led VALUE={zled|int}

    {% set zmidi_on = printer.save_variables.variables.midi_on|default("") | string %}
    RESPOND PREFIX="//" MSG="Играть MIDI при включении: {zmidi_on} // SAVE_ZMOD_DATA MIDI_ON={zmidi_on}"
    SAVE_VARIABLE VARIABLE=midi_on VALUE='"{zmidi_on|string}"'

    {% set znew_save_config = printer.save_variables.variables.new_save_config|default(0) | int %}
    {% if znew_save_config == 1 %}
        RESPOND PREFIX="//" MSG="Использовать альтернативный NEW_SAVE_CONFIG. // SAVE_ZMOD_DATA NEW_SAVE_CONFIG={znew_save_config}"
    {% else %}
        RESPOND PREFIX="//" MSG="Использовать стандартный SAVE_CONFIG. // SAVE_ZMOD_DATA NEW_SAVE_CONFIG={znew_save_config}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=new_save_config VALUE={znew_save_config|int}

    {% set zuse_swap = printer.save_variables.variables.use_swap|default(1) | int %}
    {% if zuse_swap == 0 %}
        RESPOND PREFIX="//" MSG="SWAP не используется // SAVE_ZMOD_DATA USE_SWAP={zuse_swap}"
    {% endif %}
    {% if zuse_swap == 1 %}
        RESPOND PREFIX="//" MSG="SWAP используется EMMC // SAVE_ZMOD_DATA USE_SWAP={zuse_swap}"
    {% endif %}
    {% if zuse_swap == 2 %}
        RESPOND PREFIX="//" MSG="SWAP используется USB FLASH// SAVE_ZMOD_DATA USE_SWAP={zuse_swap}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=use_swap VALUE={zuse_swap|int}

    RUN_SHELL_COMMAND CMD=zversion

[gcode_macro SET_GCODE_OFFSET]
description: Сохранение Z-Offset
rename_existing: _SET_GCODE_OFFSET
gcode:
    {% if printer.save_variables.variables.gcode_offsets %}
        {% set offsets = printer.save_variables.variables.gcode_offsets %}
    {% else %}
        {% set offsets = {'z': None} %}
    {% endif %}

    {% set ns = namespace(offsets={'z': offsets.z}) %}

    _SET_GCODE_OFFSET {% for p in params %}{'%s=%s '% (p, params[p])}{% endfor %}

    {%if 'Z' in params %}
        {% set null = ns.offsets.update({'z': params.Z}) %}
    {% endif %}

    {%if 'Z_ADJUST' in params %}
        {%if ns.offsets.z == None %}
            {% set null = ns.offsets.update({'z': 0}) %}
        {% endif %}
        {% set null = ns.offsets.update({'z': (ns.offsets.z | float) + (params.Z_ADJUST | float)}) %}
    {% endif %}
    SAVE_VARIABLE VARIABLE=gcode_offsets VALUE="{ns.offsets}"

[gcode_macro LOAD_GCODE_OFFSET]
description: Восстановление Z-Offset
gcode:
    {% if printer.save_variables.variables.gcode_offsets %}
        {% set offsets = printer.save_variables.variables.gcode_offsets %}
        _SET_GCODE_OFFSET {% for axis, offset in offsets.items() if offsets[axis] %}{ "%s=%s " % (axis, offset) }{% endfor %}
        { action_respond_info("Загружен Z-Offset из глоьальных параметров: %s" % (offsets)) }
    {% endif %}


[gcode_macro SET_FAN_SPEED]
description: Управление вентиляторами
rename_existing: _SET_FAN_SPEED
gcode:
    {% set fan = params.FAN|string %}
    {% if fan != 'pcb_fan' %}
        _SET_FAN_SPEED {% for p in params %}{'%s=%s '% (p, params[p])}{% endfor %}
    {% endif %}
